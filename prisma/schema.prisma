// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum HabitCategory {
    HEALTH
    FITNESS
    LEARNING
    PRODUCTIVITY
    MINDFULNESS
    SOCIAL
    CREATIVE
    FINANCIAL
    OTHER
}

enum AchievementCategory {
    STREAK
    COMPLETIONS
    CONSISTENCY
    SPECIAL
}

// ============================================
// USER MODEL
// ============================================

model User {
    id           String            @id // This will be the Supabase Auth user ID
    email        String            @unique
    createdAt    DateTime          @default(now())
    updatedAt    DateTime          @updatedAt
    habits       Habit[]
    stats        UserStats?
    achievements UserAchievement[]
    weeklyReviews WeeklyReview[]
    celebrations  Celebration[]
}

// ============================================
// HABIT MODEL
// ============================================

model Habit {
    id               String            @id @default(cuid())
    name             String
    frequencyPerWeek Int               // 1-7 times per week
    activeDays       Int[]             // Array of day numbers (0=Sunday, 1=Monday, etc.)
    userId           String
    user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    completions      HabitCompletion[]
    createdAt        DateTime          @default(now())
    updatedAt        DateTime          @updatedAt

    // Atomic Habits fields (Phase 1)
    category HabitCategory?
    emoji    String?

    // Streak tracking (denormalized for performance)
    streakData HabitStreak?

    // Habit strength (Phase 2)
    strengthData HabitStrength?

    @@index([userId])
    @@index([category])
}

// ============================================
// HABIT COMPLETION MODEL
// ============================================

model HabitCompletion {
    id        String   @id @default(cuid())
    habitId   String
    habit     Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)
    date      DateTime @db.Date // The specific date the habit was completed
    completed Boolean  @default(true)
    createdAt DateTime @default(now())

    @@unique([habitId, date])
    @@index([habitId])
    @@index([date])
}

// ============================================
// STREAK TRACKING (Phase 1)
// ============================================

model HabitStreak {
    id       String @id @default(cuid())
    habitId  String @unique
    habit    Habit  @relation(fields: [habitId], references: [id], onDelete: Cascade)

    currentStreak    Int @default(0)
    longestStreak    Int @default(0)
    totalCompletions Int @default(0)

    lastCompletedAt DateTime?
    streakStartedAt DateTime?

    // Two-day rule tracking
    lastMissedAt      DateTime?
    consecutiveMisses Int       @default(0)

    // Performance optimization
    lastCalculatedAt DateTime @default(now())

    updatedAt DateTime @updatedAt
}

// ============================================
// USER STATISTICS (Phase 1)
// ============================================

model UserStats {
    id     String @id @default(cuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Aggregate stats
    totalHabitsCreated Int @default(0)
    totalCompletions   Int @default(0)

    // Overall streaks (any habit completed)
    currentOverallStreak Int @default(0)
    longestOverallStreak Int @default(0)

    // Gamification (Phase 5 - placeholders)
    experiencePoints Int @default(0)
    level            Int @default(1)

    // Identity tracking
    identityVotes Int @default(0) // = totalCompletions

    // Timestamps
    lastActiveAt DateTime?
    createdAt    DateTime  @default(now())
    updatedAt    DateTime  @updatedAt

    // Relations (for future phases)
    weeklyStats WeeklyStat[]
}

// ============================================
// WEEKLY STATISTICS (Phase 2 - placeholder)
// ============================================

model WeeklyStat {
    id          String    @id @default(cuid())
    userStatsId String
    userStats   UserStats @relation(fields: [userStatsId], references: [id], onDelete: Cascade)

    weekStartDate DateTime @db.Date
    weekEndDate   DateTime @db.Date

    // Metrics
    completionRate  Float // 0.0 - 1.0
    habitsCompleted Int
    habitsPossible  Int

    // Comparison
    improvementRate Float? // % change from previous week

    createdAt DateTime @default(now())

    @@unique([userStatsId, weekStartDate])
    @@index([weekStartDate])
}

// ============================================
// ACHIEVEMENT SYSTEM (Phase 1)
// ============================================

model Achievement {
    id          String              @id @default(cuid())
    key         String              @unique // e.g., "streak_7", "completions_100"
    name        String
    description String
    emoji       String
    category    AchievementCategory
    threshold   Int                 // Value needed to unlock
    xpReward    Int                 @default(10)

    userAchievements UserAchievement[]

    createdAt DateTime @default(now())
}

model UserAchievement {
    id            String      @id @default(cuid())
    userId        String
    achievementId String
    user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

    earnedAt   DateTime @default(now())
    celebrated Boolean  @default(false) // Has user seen/dismissed the celebration?

    @@unique([userId, achievementId])
    @@index([userId])
}

// ============================================
// HABIT STRENGTH (Phase 2)
// ============================================

model HabitStrength {
    id      String @id @default(cuid())
    habitId String @unique
    habit   Habit  @relation(fields: [habitId], references: [id], onDelete: Cascade)

    // Current strength score (0-100)
    strength Int @default(0)

    // Individual factor scores (0-100 each)
    currentStreakScore Int @default(0)
    consistencyScore   Int @default(0)
    longevityScore     Int @default(0)
    recoveryScore      Int @default(0)
    trendScore         Int @default(0)

    // Tracking data for calculations
    missedDaysCount Int @default(0) // Total missed active days
    recoveryCount   Int @default(0) // Times recovered within 1 day
    last30DaysRate  Float @default(0) // Consistency percentage for last 30 days

    updatedAt DateTime @updatedAt
}

// ============================================
// WEEKLY REVIEW (Phase 2)
// ============================================

model WeeklyReview {
    id     String @id @default(cuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Time period
    weekStartDate DateTime @db.Date // Monday of the week
    weekEndDate   DateTime @db.Date // Sunday of the week

    // Core metrics
    completionRate Float // 0-100
    totalCompleted Int
    totalPossible  Int

    // Comparison
    previousWeekRate   Float?
    changeFromPrevious Float? // Percentage change (+12%, -5%)

    // Analysis
    bestHabitId          String?
    worstHabitId         String?
    longestStreakHabitId String?
    newStreakMilestones  Json? // Array of milestones hit this week

    // Generated content
    wins            Json   // Array of win strings
    needsAttention  Json   // Array of attention strings
    focusSuggestion String? // Personalized suggestion for next week
    insights        Json?  // Additional insights

    // Habits performance breakdown
    habitPerformance Json? // Array of per-habit performance data

    // Meta
    generatedAt DateTime  @default(now())
    viewedAt    DateTime? // When user first viewed it

    @@unique([userId, weekStartDate])
    @@index([userId, weekStartDate])
}

// ============================================
// CELEBRATIONS (Phase 2)
// ============================================

model Celebration {
    id      String @id @default(cuid())
    userId  String
    user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    type    String  // Milestone type (streak_7, perfect_week, etc.)
    habitId String? // Related habit (if applicable)
    value   Int     // The milestone value (7 for streak_7)

    title   String // Display title
    message String // Display message

    triggeredAt DateTime  @default(now())
    viewedAt    DateTime?
    sharedAt    DateTime?

    @@index([userId, triggeredAt])
}
